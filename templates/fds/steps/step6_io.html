<fieldset class="form-step" id="step-6">
  <div class="step-header">
    <h1 class="step-legend">
      <i class="fas fa-diagram-project"></i>
      Step 6 - System Architecture
    </h1>
  </div>

  <div class="data-card" id="system-architecture-card">
    <div class="card-header">
      <span>System Architecture Designer</span>
      <div class="header-controls">
        <label class="toggle" title="Toggle high contrast canvas theme">
          <input type="checkbox" id="arch-toggle-high-contrast"/>
          <span>High contrast</span>
        </label>
        <label class="toggle" title="Enable colorblind friendly palette">
          <input type="checkbox" id="arch-toggle-colorblind"/>
          <span>Color safe</span>
        </label>
        <button type="button" class="icon-btn" id="arch-shortcuts" title="Keyboard shortcuts">
          <i class="fas fa-keyboard"></i>
        </button>
      </div>
    </div>

    <div class="card-body architecture-shell">
      <aside class="architecture-sidebar" id="architecture-sidebar">
        <div class="arch-panel">
          <div class="panel-header">
            <span><i class="fas fa-layer-group"></i> Templates</span>
            <div class="panel-actions">
              <button type="button" class="icon-btn" id="arch-refresh-templates" title="Refresh templates">
                <i class="fas fa-rotate"></i>
              </button>
            </div>
          </div>
          <div class="panel-body" id="arch-template-list">
            <p class="panel-empty">No templates yet. Save one from the current layout.</p>
          </div>
          <div class="panel-footer">
            <input type="text" id="arch-template-name" class="panel-input" placeholder="Template name"/>
            <div class="panel-footer-actions">
              <button type="button" class="btn btn-tertiary" id="arch-save-template">
                <i class="fas fa-bookmark"></i> Save Template
              </button>
            </div>
          </div>
        </div>

        <div class="arch-panel" id="arch-layers-panel">
          <div class="panel-header">
            <span><i class="fas fa-layer-group"></i> Layers</span>
            <div class="panel-actions">
              <button type="button" class="icon-btn" id="arch-add-layer" title="Add new layer">
                <i class="fas fa-plus"></i>
              </button>
            </div>
          </div>
          <div class="panel-body" id="arch-layer-list">
            <p class="panel-empty">Create layers to organize your diagram.</p>
          </div>
          <div class="panel-footer">
            <label class="toggle" title="Lock currently active layer">
              <input type="checkbox" id="arch-toggle-active-layer-lock"/>
              <span>Lock active layer</span>
            </label>
            <label class="toggle" title="Show only the active layer">
              <input type="checkbox" id="arch-toggle-layer-isolation"/>
              <span>Solo layer</span>
            </label>
          </div>
        </div>

        <div class="arch-panel arch-assets-panel">
          <div class="panel-header">
            <span><i class="fas fa-icons"></i> Asset Library</span>
            <div class="panel-actions">
              <label class="upload-btn" title="Upload custom asset image">
                <input type="file" id="arch-upload-asset-input" accept="image/*"/>
                <i class="fas fa-upload"></i>
              </label>
            </div>
          </div>
          <div class="panel-body assets-body" id="arch-asset-list">
            <p class="panel-empty">Drag assets into the canvas or drop them on a node to swap images.</p>
          </div>
        </div>

        <div class="arch-panel" id="arch-modules-panel">
          <div class="panel-header">
            <span><i class="fas fa-cubes"></i> Reusable Modules</span>
            <div class="panel-actions">
              <button type="button" class="icon-btn" id="arch-refresh-modules" title="Refresh modules">
                <i class="fas fa-rotate"></i>
              </button>
            </div>
          </div>
          <div class="panel-body" id="arch-module-list">
            <p class="panel-empty">Select devices and save them as reusable modules.</p>
          </div>
          <div class="panel-footer">
            <input type="text" id="arch-module-name" class="panel-input" placeholder="Module name"/>
            <div class="panel-footer-actions">
              <button type="button" class="btn btn-secondary" id="arch-save-module">
                <i class="fas fa-save"></i> Save Selection
              </button>
              <button type="button" class="btn btn-tertiary" id="arch-insert-module">
                <i class="fas fa-plus-circle"></i> Insert Selected
              </button>
            </div>
          </div>
        </div>

        <div class="arch-panel" id="arch-integration-panel">
          <div class="panel-header">
            <span><i class="fas fa-plug"></i> Import / Sync</span>
          </div>
          <div class="panel-body integration-body">
            <button type="button" class="btn btn-tertiary full-width" id="arch-import-json">
              <i class="fas fa-file-code"></i> Import JSON Layout
            </button>
            <button type="button" class="btn btn-tertiary full-width" id="arch-import-visio">
              <i class="fas fa-file-import"></i> Import Visio / VSDX
            </button>
            <button type="button" class="btn btn-tertiary full-width" id="arch-import-dxf">
              <i class="fas fa-drafting-compass"></i> Import DXF / DWG
            </button>
            <button type="button" class="btn btn-tertiary full-width" id="arch-sync-plc">
              <i class="fas fa-network-wired"></i> Sync with PLC Config
            </button>
          </div>
        </div>
      </aside>

      <div class="architecture-main">
        <div class="architecture-toolbar" id="architecture-toolbar">
          <div class="toolbar-group">
            <button type="button" class="tool-btn is-active" data-tool="select" id="arch-tool-select" title="Select (V)">
              <i class="fas fa-mouse-pointer"></i>
            </button>
            <button type="button" class="tool-btn" data-tool="connector" id="arch-tool-connector" title="Connector (C)">
              <i class="fas fa-link"></i>
            </button>
            <button type="button" class="tool-btn" data-tool="annotation" id="arch-tool-annotation" title="Sticky note (N)">
              <i class="fas fa-sticky-note"></i>
            </button>
            <button type="button" class="tool-btn" data-tool="pan" id="arch-tool-pan" title="Pan canvas (Space)">
              <i class="fas fa-arrows-alt"></i>
            </button>
          </div>

          <div class="toolbar-group">
            <button type="button" class="tool-btn" id="arch-tool-copy" title="Copy (Ctrl+C)">
              <i class="fas fa-copy"></i>
            </button>
            <button type="button" class="tool-btn" id="arch-tool-paste" title="Paste (Ctrl+V)">
              <i class="fas fa-paste"></i>
            </button>
            <button type="button" class="tool-btn" id="arch-tool-duplicate" title="Duplicate (Ctrl+D)">
              <i class="fas fa-clone"></i>
            </button>
            <button type="button" class="tool-btn" id="arch-tool-delete" title="Delete (Delete)">
              <i class="fas fa-trash"></i>
            </button>
          </div>

          <div class="toolbar-group">
            <button type="button" class="tool-btn" id="arch-tool-group" title="Group (Ctrl+G)">
              <i class="fas fa-object-group"></i>
            </button>
            <button type="button" class="tool-btn" id="arch-tool-ungroup" title="Ungroup (Ctrl+Shift+G)">
              <i class="fas fa-object-ungroup"></i>
            </button>
            <button type="button" class="tool-btn" id="arch-tool-create-module" title="Capture as module">
              <i class="fas fa-cube"></i>
            </button>
          </div>

          <div class="toolbar-group">
            <button type="button" class="tool-btn" id="arch-align-left" title="Align Left">
              <i class="fas fa-align-left"></i>
            </button>
            <button type="button" class="tool-btn" id="arch-align-center" title="Align Center">
              <i class="fas fa-align-center"></i>
            </button>
            <button type="button" class="tool-btn" id="arch-distribute-horizontal" title="Distribute Horizontally">
              <i class="fas fa-arrows-left-right"></i>
            </button>
            <button type="button" class="tool-btn" id="arch-distribute-vertical" title="Distribute Vertically">
              <i class="fas fa-arrows-up-down"></i>
            </button>
            <button type="button" class="tool-btn" id="arch-auto-arrange" title="Auto Arrange Layout">
              <i class="fas fa-wave-square"></i>
            </button>
          </div>

          <div class="toolbar-group">
            <button type="button" class="tool-btn" id="arch-tool-autoroute" title="Auto-route connectors">
              <i class="fas fa-route"></i>
            </button>
            <button type="button" class="tool-btn" id="arch-tool-highlight-flow" title="Highlight signal flow">
              <i class="fas fa-project-diagram"></i>
            </button>
            <button type="button" class="tool-btn" id="arch-tool-validate" title="Run signal validation">
              <i class="fas fa-traffic-light"></i>
            </button>
          </div>

          <div class="toolbar-group">
            <button type="button" class="tool-btn" id="arch-undo" title="Undo (Ctrl+Z)">
              <i class="fas fa-undo-alt"></i>
            </button>
            <button type="button" class="tool-btn" id="arch-redo" title="Redo (Ctrl+Y)">
              <i class="fas fa-redo-alt"></i>
            </button>
          </div>
        </div>

        <div class="architecture-stage-wrapper" id="architecture-stage-wrapper">
          <div class="architecture-ruler horizontal" id="architecture-ruler-horizontal"></div>
          <div class="architecture-ruler vertical" id="architecture-ruler-vertical"></div>
          <div id="architecture-stage" class="architecture-stage"></div>
          <div class="architecture-cursors" id="architecture-cursors"></div>
          <div class="architecture-annotation-layer" id="architecture-annotation-layer"></div>
          <div id="architecture-minimap" class="architecture-minimap"></div>
          <div class="architecture-grid-overlay" id="architecture-grid-overlay"></div>
          <div class="architecture-measure-overlay" id="architecture-measure-overlay"></div>
          <div class="architecture-empty-state" id="architecture-empty-state">
            <i class="fas fa-sitemap"></i>
            <p>Generate from Step 4 or drag devices here to build your architecture.</p>
          </div>
        </div>

        <div class="architecture-utilities">
          <section class="utility-section" id="architecture-validation-section">
            <header>
              <i class="fas fa-shield-alt"></i>
              <span>Signal Validation</span>
            </header>
            <p class="utility-hint">Check for mismatched signal types, unassigned layers, and incomplete links.</p>
            <div class="utility-actions">
              <button type="button" class="btn btn-secondary" id="arch-run-validation">
                <i class="fas fa-wave-square"></i> Run Validation
              </button>
              <label class="toggle" title="Automatically validate whenever connectors change">
                <input type="checkbox" id="arch-toggle-auto-validation" checked/>
                <span>Auto validate links</span>
              </label>
            </div>
            <ul id="arch-validation-results" class="utility-log"></ul>
          </section>

          <section class="utility-section" id="architecture-simulation-section">
            <header>
              <i class="fas fa-play-circle"></i>
              <span>Simulation &amp; Testing</span>
            </header>
            <p class="utility-hint">Simulate logic flow to confirm redundancy and connectivity.</p>
            <div class="utility-actions">
              <button type="button" class="btn btn-secondary" id="arch-run-simulation">
                <i class="fas fa-play"></i> Simulate Flow
              </button>
              <button type="button" class="btn btn-tertiary" id="arch-generate-test-report">
                <i class="fas fa-file-alt"></i> Export Test Log
              </button>
            </div>
            <ul id="arch-simulation-results" class="utility-log"></ul>
          </section>

          <section class="utility-section" id="architecture-collaboration-section">
            <header>
              <i class="fas fa-users"></i>
              <span>Collaboration</span>
            </header>
            <div class="collaboration-meta">
              <div class="collaborator-badges" id="arch-collaborator-list">
                <span class="badge badge-muted">No collaborators online</span>
              </div>
              <button type="button" class="icon-btn" id="arch-lock-selection" title="Lock current selection from edits">
                <i class="fas fa-lock"></i>
              </button>
            </div>
            <div class="collaboration-chat">
              <div class="chat-log" id="arch-chat-log">
                <p class="chat-empty">Start a thread to discuss layout changes.</p>
              </div>
              <div class="chat-input">
                <textarea id="arch-chat-message" rows="2" placeholder="Enter message..."></textarea>
                <button type="button" class="btn btn-tertiary" id="arch-chat-send">
                  <i class="fas fa-paper-plane"></i>
                </button>
              </div>
            </div>
          </section>

          <section class="utility-section" id="architecture-annotations-section">
            <header>
              <i class="fas fa-comment-dots"></i>
              <span>Annotations</span>
            </header>
            <p class="utility-hint">Attach sticky notes or callouts directly to devices and connectors.</p>
            <div class="annotation-actions">
              <button type="button" class="btn btn-secondary" id="arch-add-sticky">
                <i class="fas fa-note-sticky"></i> Add Sticky Note
              </button>
              <button type="button" class="btn btn-tertiary" id="arch-add-callout">
                <i class="fas fa-bullhorn"></i> Add Callout
              </button>
            </div>
            <ul id="arch-annotation-thread" class="utility-log"></ul>
          </section>
        </div>

        <div class="architecture-footer">
          <div class="footer-section">
            <label class="footer-label" for="arch-zoom-slider"><i class="fas fa-search"></i> Zoom</label>
            <div class="zoom-controls">
              <button type="button" class="zoom-btn" id="arch-zoom-out"><i class="fas fa-minus"></i></button>
              <input type="range" min="0.25" max="2.5" step="0.05" value="1" id="arch-zoom-slider"/>
              <button type="button" class="zoom-btn" id="arch-zoom-in"><i class="fas fa-plus"></i></button>
            </div>
          </div>

          <div class="footer-section toggles">
            <label class="toggle">
              <input type="checkbox" id="arch-toggle-grid" checked/>
              <span>Grid</span>
            </label>
            <label class="toggle">
              <input type="checkbox" id="arch-toggle-snap" checked/>
              <span>Snap to grid</span>
            </label>
            <label class="toggle">
              <input type="checkbox" id="arch-toggle-snap-ports" checked/>
              <span>Snap to ports</span>
            </label>
            <label class="toggle">
              <input type="checkbox" id="arch-toggle-rulers" checked/>
              <span>Rulers</span>
            </label>
            <label class="toggle">
              <input type="checkbox" id="arch-toggle-measure"/>
              <span>Measurement guides</span>
            </label>
          </div>

          <div class="footer-section exports">
            <button type="button" class="btn btn-tertiary" id="arch-export-png">
              <i class="fas fa-file-image"></i> PNG
            </button>
            <button type="button" class="btn btn-tertiary" id="arch-export-pdf">
              <i class="fas fa-file-pdf"></i> PDF
            </button>
            <button type="button" class="btn btn-tertiary" id="arch-export-svg">
              <i class="fas fa-drafting-compass"></i> SVG
            </button>
            <button type="button" class="btn btn-tertiary" id="arch-export-report">
              <i class="fas fa-list"></i> Signal Map
            </button>
          </div>
        </div>
      </div>

      <aside class="architecture-inspector" id="architecture-inspector">
        <div class="inspector-header">
          <span><i class="fas fa-info-circle"></i> Inspector</span>
          <button type="button" class="icon-btn" id="inspector-collapse">
            <i class="fas fa-chevron-right"></i>
          </button>
        </div>
        <div class="inspector-content">
          <section class="inspector-section" data-view="node">
            <h4>Device</h4>
            <label>
              <span>Label</span>
              <input type="text" id="inspector-node-label"/>
            </label>
            <label>
              <span>Model</span>
              <input type="text" id="inspector-node-model"/>
            </label>
            <label>
              <span>Layer</span>
              <select id="inspector-node-layer"></select>
            </label>
            <div class="inspector-grid">
              <label>
                <span>Protocol</span>
                <input type="text" id="inspector-node-protocol" placeholder="EtherNet/IP, Modbus TCP..."/>
              </label>
              <label>
                <span>Signal Type</span>
                <select id="inspector-node-signal-type">
                  <option value="">Auto</option>
                  <option value="digital">Digital</option>
                  <option value="analog">Analog</option>
                  <option value="network">Network</option>
                  <option value="control">Control Logic</option>
                </select>
              </label>
            </div>
            <div class="inspector-grid">
              <label>
                <span>IP Address</span>
                <input type="text" id="inspector-node-ip" placeholder="192.168.0.10"/>
              </label>
              <label>
                <span>Slot / Rack</span>
                <input type="text" id="inspector-node-slot" placeholder="Rack 0 / Slot 1"/>
              </label>
            </div>
            <div class="inspector-grid">
              <label>
                <span>Power Rating</span>
                <input type="text" id="inspector-node-power" placeholder="24VDC / 2A"/>
              </label>
              <label>
                <span>Status</span>
                <select id="inspector-node-status">
                  <option value="operational">Operational</option>
                  <option value="standby">Standby</option>
                  <option value="maintenance">Maintenance</option>
                  <option value="deprecated">Deprecated</option>
                </select>
              </label>
            </div>
            <label>
              <span>Tags</span>
              <input type="text" id="inspector-node-tags" placeholder="PLC, Field, VLAN10"/>
            </label>
            <label>
              <span>Notes</span>
              <textarea id="inspector-node-notes" rows="2"></textarea>
            </label>
            <button type="button" class="btn btn-secondary inspector-apply" id="inspector-node-apply">
              <i class="fas fa-check"></i> Apply Changes
            </button>
          </section>

          <section class="inspector-section" data-view="connection">
            <h4>Connection</h4>
            <label>
              <span>Label</span>
              <input type="text" id="inspector-connection-label" placeholder="Ethernet uplink"/>
            </label>
            <div class="inspector-grid">
              <label>
                <span>Type</span>
                <select id="inspector-connection-type">
                  <option value="">Auto</option>
                  <option value="digital">Digital</option>
                  <option value="analog">Analog</option>
                  <option value="network">Network</option>
                  <option value="control">Control</option>
                  <option value="safety">Safety</option>
                </select>
              </label>
              <label>
                <span>Color</span>
                <input type="color" id="inspector-connection-color" value="#1f2937"/>
              </label>
            </div>
            <div class="inspector-grid">
              <label>
                <span>Width</span>
                <input type="number" id="inspector-connection-width" min="1" max="12" step="1" value="2"/>
              </label>
              <label>
                <span>Style</span>
                <select id="inspector-connection-style">
                  <option value="curved">Curved</option>
                  <option value="straight">Straight</option>
                  <option value="orthogonal">Orthogonal</option>
                </select>
              </label>
            </div>
            <div class="inspector-grid">
              <label>
                <span>Start Arrow</span>
                <select id="inspector-connection-arrow-start">
                  <option value="none">None</option>
                  <option value="circle">Circle</option>
                  <option value="triangle">Triangle</option>
                </select>
              </label>
              <label>
                <span>End Arrow</span>
                <select id="inspector-connection-arrow-end">
                  <option value="triangle">Triangle</option>
                  <option value="circle">Circle</option>
                  <option value="none">None</option>
                </select>
              </label>
            </div>
            <label>
              <span>Badges</span>
              <input type="text" id="inspector-connection-badges" placeholder="Redundant, Fiber, Shielded"/>
            </label>
            <label>
              <span>Notes</span>
              <textarea id="inspector-connection-notes" rows="2"></textarea>
            </label>
            <button type="button" class="btn btn-secondary inspector-apply" id="inspector-connection-apply">
              <i class="fas fa-check"></i> Apply Changes
            </button>
          </section>

          <section class="inspector-section" data-view="canvas">
            <h4>Canvas</h4>
            <label>
              <span>Background</span>
              <input type="color" id="inspector-canvas-background" value="#f5f7fb"/>
            </label>
            <label>
              <span>Grid Size</span>
              <input type="number" id="inspector-canvas-grid-size" min="8" max="160" step="4" value="32"/>
            </label>
            <label>
              <span>Canvas Width (px)</span>
              <input type="number" id="inspector-canvas-width" min="640" max="4000" step="40"/>
            </label>
            <label>
              <span>Canvas Height (px)</span>
              <input type="number" id="inspector-canvas-height" min="480" max="3000" step="40"/>
            </label>
            <button type="button" class="btn btn-secondary inspector-apply" id="inspector-canvas-apply">
              <i class="fas fa-check"></i> Apply Canvas Settings
            </button>
          </section>

          <section class="inspector-section" data-view="bulk">
            <h4>Bulk Edit</h4>
            <p class="inspector-hint">Update shared properties for the current selection.</p>
            <button type="button" class="btn btn-secondary inspector-apply" id="inspector-bulk-layer">
              <i class="fas fa-layer-group"></i> Assign Layer
            </button>
            <button type="button" class="btn btn-tertiary inspector-apply" id="inspector-bulk-signal">
              <i class="fas fa-plug"></i> Set Signal Type
            </button>
            <button type="button" class="btn btn-tertiary inspector-apply" id="inspector-bulk-color">
              <i class="fas fa-fill-drip"></i> Colorize
            </button>
          </section>

          <section class="inspector-section" data-view="filters">
            <h4>Filter &amp; Find</h4>
            <label>
              <span>Search</span>
              <input type="search" id="inspector-filter-search" placeholder="Device, tag, IP..."/>
            </label>
            <label>
              <span>Component Type</span>
              <select id="inspector-filter-component">
                <option value="">All</option>
                <option value="plc">PLC</option>
                <option value="io">I/O</option>
                <option value="network">Network</option>
                <option value="hmi">HMI</option>
                <option value="safety">Safety</option>
              </select>
            </label>
            <label>
              <span>Status</span>
              <select id="inspector-filter-status">
                <option value="">All</option>
                <option value="operational">Operational</option>
                <option value="standby">Standby</option>
                <option value="maintenance">Maintenance</option>
                <option value="deprecated">Deprecated</option>
              </select>
            </label>
            <button type="button" class="btn btn-tertiary inspector-apply" id="inspector-apply-filter">
              <i class="fas fa-filter"></i> Apply Filter
            </button>
            <button type="button" class="btn btn-tertiary inspector-apply" id="inspector-clear-filter">
              <i class="fas fa-times-circle"></i> Clear
            </button>
          </section>
        </div>
      </aside>
    </div>

    <div class="architecture-bottom-bar">
      <div class="bottom-left">
        <button type="button" class="btn btn-secondary" id="arch-save-version">
          <i class="fas fa-book-medical"></i> Save Snapshot
        </button>
        <select id="arch-version-selector" class="version-selector">
          <option value="">Version history</option>
        </select>
      </div>
      <div class="bottom-center">
        <label class="toggle">
          <input type="checkbox" id="arch-live-sync"/>
          <span>Live co-editing</span>
        </label>
        <span class="collab-status" id="arch-collab-status">
          <i class="fas fa-user-slash"></i> Offline
        </span>
      </div>
      <div class="bottom-right architecture-actions">
        <button type="button" class="btn btn-secondary" id="btn-generate-architecture">
          <i class="fas fa-diagram-project"></i> Generate from Equipment List
        </button>
        <button type="button" class="btn btn-tertiary" id="btn-architecture-reset">
          <i class="fas fa-undo-alt"></i> Reset Layout
        </button>
        <button type="button" class="btn btn-primary" id="btn-architecture-save">
          <i class="fas fa-save"></i> Store Layout
        </button>
        <button type="button" class="btn btn-primary" id="btn-architecture-sync">
          <i class="fas fa-cloud-upload-alt"></i> Sync to Report
        </button>
      </div>
    </div>
  </div>

  <input type="hidden"
         name="system_architecture_layout"
         id="system_architecture_layout"
         value="{{ submission_data.SYSTEM_ARCHITECTURE_LAYOUT | default('') }}"/>

  <div class="btn-group">
    <button type="button" class="btn btn-secondary" onclick="goToStep(5)">
      <i class="fas fa-arrow-left"></i> Previous
    </button>
    <button type="button" class="btn btn-primary" onclick="goToStep(7)">
      <i class="fas fa-arrow-right"></i> Next Step
    </button>
  </div>
</fieldset>
