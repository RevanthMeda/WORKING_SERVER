<fieldset class="form-step" id="step-6">
  <div class="step-header">
    <h1 class="step-legend">
      <i class="fas fa-diagram-project"></i>
      Step 6 - System Architecture & Modbus Registers
    </h1>
  </div>

  <div class="data-card" id="system-architecture-card">
    <div class="card-header">
      <span>System Architecture Designer</span>
    </div>
    <div class="card-body">
      <p class="helper-text">
        Generate a draft architecture from the Step 4 equipment list, then drag devices or swap images to finalise the network diagram.
      </p>
      <div class="architecture-actions">
        <button type="button" class="btn btn-secondary" id="btn-generate-architecture">
          <i class="fas fa-diagram-project"></i> Generate from Equipment List
        </button>
        <button type="button" class="btn btn-tertiary" id="btn-architecture-reset">
          <i class="fas fa-undo-alt"></i> Reset Layout
        </button>
        <button type="button" class="btn btn-primary" id="btn-architecture-save">
          <i class="fas fa-save"></i> Store Layout
        </button>
      </div>
      <div id="architecture-workspace" class="architecture-workspace">
        <canvas id="architecture-canvas" class="architecture-canvas"></canvas>
        <div class="architecture-empty-state" id="architecture-empty-state">
          <i class="fas fa-sitemap"></i>
          <p>Use the controls above to populate the architecture canvas.</p>
        </div>
      </div>
    </div>
  </div>

  <div class="data-card">
    <div class="card-header">
      <span>Document Version Control</span>
    </div>
    <div class="card-body">
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Revision Number</th>
              <th>Details</th>
              <th>Date</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="version-history-body">
            {% if submission_data.VERSION_HISTORY %}
              {% for row in submission_data.VERSION_HISTORY %}
              <tr>
                <td><input name="version_revision[]" value="{{ row.Revision }}"/></td>
                <td><input name="version_details[]" value="{{ row.Details }}"/></td>
                <td><input name="version_date[]" type="date" value="{{ row.Date }}"/></td>
                <td><button type="button" class="btn-remove" onclick="removeRow(this)"><i class="fas fa-trash"></i></button></td>
              </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td><input name="version_revision[]" placeholder="R0"/></td>
                <td><input name="version_details[]" placeholder="Initial Document"/></td>
                <td><input name="version_date[]" type="date"/></td>
                <td><button type="button" class="btn-remove" onclick="removeRow(this)"><i class="fas fa-trash"></i></button></td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
      <button type="button" class="btn btn-add" onclick="addRow('tmpl-version-history', 'version-history-body')">
        <i class="fas fa-plus"></i> Add Revision
      </button>
    </div>
  </div>

  <div class="form-section">
    <h4><i class="fas fa-lock"></i> Confidentiality Notice</h4>
    <div class="confidentiality-box">
      <p>
        This document contains confidential and proprietary information of Cully. Unauthorized distribution
        or reproduction is strictly prohibited. Please ensure this notice accompanies the final FDS output.
      </p>
    </div>
    <div class="form-group" style="margin-top:16px;">
      <label for="confidentiality_notice">Custom Confidentiality Statement (optional)</label>
      <textarea id="confidentiality_notice" name="confidentiality_notice"
        placeholder="Enter an additional notice if required.">{{ submission_data.CONFIDENTIALITY_NOTICE }}</textarea>
    </div>
  </div>

  <div class="data-card">
    <div class="card-header">
      <span>Modbus Digital Registers</span>
    </div>
    <div class="card-body">
      <p class="helper-text">
        Document coil/bit addresses in the order they will appear on the architecture diagram. Use remarks for protocol notes or scaling references.
      </p>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>S.No</th>
              <th>Address</th>
              <th>Description</th>
              <th>Remarks</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="modbus-digital-body">
            {% if submission_data.MODBUS_DIGITAL_REGISTERS %}
              {% for row in submission_data.MODBUS_DIGITAL_REGISTERS %}
              <tr>
                <td><input name="modbus_digital_s_no[]" value="{{ row.S_No }}"/></td>
                <td><input name="modbus_digital_address[]" value="{{ row.Address }}"/></td>
                <td><input name="modbus_digital_description[]" value="{{ row.Description }}"/></td>
                <td><input name="modbus_digital_remarks[]" value="{{ row.Remarks }}"/></td>
                <td><button type="button" class="btn-remove" onclick="removeRow(this)"><i class="fas fa-trash"></i></button></td>
              </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td><input name="modbus_digital_s_no[]" placeholder="1"/></td>
                <td><input name="modbus_digital_address[]" placeholder="MW2800.0"/></td>
                <td><input name="modbus_digital_description[]" placeholder="Supply Healthy"/></td>
                <td><input name="modbus_digital_remarks[]" placeholder="Remarks"/></td>
                <td><button type="button" class="btn-remove" onclick="removeRow(this)"><i class="fas fa-trash"></i></button></td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
      <button type="button" class="btn btn-add" onclick="addRow('tmpl-modbus-digital', 'modbus-digital-body')">
        <i class="fas fa-plus"></i> Add Digital Register
      </button>
    </div>
  </div>

  <div class="data-card">
    <div class="card-header">
      <span>Modbus Analogue List</span>
    </div>
    <div class="card-body">
      <p class="helper-text">
        Capture analogue registers (holding/input) with a short description and any calibration notes in the remarks field.
      </p>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>S.No</th>
              <th>Address</th>
              <th>Description</th>
              <th>Remarks</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="modbus-analog-body">
            {% if submission_data.MODBUS_ANALOG_REGISTERS %}
              {% for row in submission_data.MODBUS_ANALOG_REGISTERS %}
              <tr>
                <td><input name="modbus_analog_s_no[]" value="{{ row.S_No }}"/></td>
                <td><input name="modbus_analog_address[]" value="{{ row.Address }}"/></td>
                <td><input name="modbus_analog_description[]" value="{{ row.Description }}"/></td>
                <td><input name="modbus_analog_remarks[]" value="{{ row.Remarks }}"/></td>
                <td><button type="button" class="btn-remove" onclick="removeRow(this)"><i class="fas fa-trash"></i></button></td>
              </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td><input name="modbus_analog_s_no[]" placeholder="1"/></td>
                <td><input name="modbus_analog_address[]" placeholder="MW110"/></td>
                <td><input name="modbus_analog_description[]" placeholder="Wet Well Primary Level"/></td>
                <td><input name="modbus_analog_remarks[]" placeholder="Remarks"/></td>
                <td><button type="button" class="btn-remove" onclick="removeRow(this)"><i class="fas fa-trash"></i></button></td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
      <button type="button" class="btn btn-add" onclick="addRow('tmpl-modbus-analog', 'modbus-analog-body')">
        <i class="fas fa-plus"></i> Add Analogue Register
      </button>
    </div>
  </div>

  <div class="form-section">
    <h4><i class="fas fa-lightbulb"></i> System Overview and Purpose</h4>
    <div class="form-group">
      <label for="system_overview">System Overview</label>
      <textarea id="system_overview" name="system_overview"
        placeholder="Describe the system, architecture and overall context.">{{ submission_data.SYSTEM_OVERVIEW }}</textarea>
    </div>
    <div class="form-group">
      <label for="system_purpose">System Purpose</label>
      <textarea id="system_purpose" name="system_purpose"
        placeholder="Outline the objectives and business outcomes">{{ submission_data.SYSTEM_PURPOSE }}</textarea>
    </div>
  </div>

  <div class="form-section">
    <h4><i class="fas fa-tasks"></i> Scope of Work</h4>
    <div class="form-group">
      <label for="scope_of_work">Scope Definition</label>
      <textarea id="scope_of_work" name="scope_of_work"
        placeholder="List included subsystems, locations, constraints and exclusions">{{ submission_data.SCOPE_OF_WORK }}</textarea>
    </div>
  </div>

  <div class="form-section">
    <h4><i class="fas fa-list-alt"></i> Functional Requirements &amp; Control Philosophy</h4>
    <div class="form-group">
      <label for="functional_requirements">Functional Requirements</label>
      <textarea id="functional_requirements" name="functional_requirements"
        placeholder="Detail the functional behaviour expected from the control system">{{ submission_data.FUNCTIONAL_REQUIREMENTS }}</textarea>
    </div>
    <div class="form-group">
      <label for="process_description">Process Description</label>
      <textarea id="process_description" name="process_description"
        placeholder="Describe the process flow supported by this automation">{{ submission_data.PROCESS_DESCRIPTION }}</textarea>
    </div>
    <div class="form-group">
      <label for="control_philosophy">Control Philosophy</label>
      <textarea id="control_philosophy" name="control_philosophy"
        placeholder="Document the control strategy, sequences and interlocks">{{ submission_data.CONTROL_PHILOSOPHY }}</textarea>
    </div>
  </div>
  <input type="hidden"
         name="system_architecture_layout"
         id="system_architecture_layout"
         value="{{ submission_data.SYSTEM_ARCHITECTURE_LAYOUT | default('') }}"/>
  <div class="btn-group">
    <button type="button" class="btn btn-secondary" onclick="goToStep(5)">
      <i class="fas fa-arrow-left"></i> Previous
    </button>
    <button type="button" class="btn btn-primary" onclick="goToStep(7)">
      <i class="fas fa-arrow-right"></i> Next Step
    </button>
  </div>
</fieldset>
