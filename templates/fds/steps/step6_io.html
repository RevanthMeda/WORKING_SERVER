<fieldset class="form-step" id="step-6">
  <div class="step-header">
    <h1 class="step-legend">
      <i class="fas fa-diagram-project"></i>
      Step 6 - System Architecture
    </h1>
  </div>

  <div class="data-card" id="system-architecture-card">
    <div class="card-header">
      <span>System Architecture Designer</span>
      <div class="architecture-status" id="architecture-status-indicator" data-state="idle">
        <i class="fas fa-circle"></i>
        <span class="status-label">Idle</span>
      </div>
    </div>

    <div class="card-body architecture-shell">
      <aside class="architecture-sidebar" id="architecture-sidebar">
        <div class="arch-panel">
          <div class="panel-header">
            <span><i class="fas fa-layer-group"></i> Templates</span>
            <div class="panel-actions">
              <button type="button" class="icon-btn" id="arch-refresh-templates" title="Refresh templates">
                <i class="fas fa-rotate"></i>
              </button>
            </div>
          </div>
          <div class="panel-body" id="arch-template-list">
            <p class="panel-empty">No templates yet. Save one from the current layout.</p>
          </div>
          <div class="panel-footer">
            <input type="text" id="arch-template-name" class="panel-input" placeholder="Template name"/>
            <div class="panel-footer-actions">
              <button type="button" class="btn btn-tertiary" id="arch-save-template">
                <i class="fas fa-bookmark"></i> Save Template
              </button>
            </div>
          </div>
        </div>

        <div class="arch-panel arch-assets-panel">
          <div class="panel-header">
            <span><i class="fas fa-icons"></i> Asset Library</span>
            <div class="panel-actions">
              <label class="upload-btn">
                <input type="file" id="arch-upload-asset-input" accept="image/*"/>
                <i class="fas fa-upload"></i>
              </label>
            </div>
          </div>
          <div class="panel-body assets-body" id="arch-asset-list">
            <p class="panel-empty">Drag assets into the canvas or drop them on a node to swap images.</p>
          </div>
        </div>
      </aside>

      <div class="architecture-main">
        <div class="architecture-toolbar" id="architecture-toolbar">
          <div class="toolbar-group">
            <button type="button" class="tool-btn is-active" data-tool="select" id="arch-tool-select" title="Select">
              <i class="fas fa-mouse-pointer"></i>
            </button>
            <button type="button" class="tool-btn" data-tool="connector" id="arch-tool-connector" title="Connector">
              <i class="fas fa-link"></i>
            </button>
            <button type="button" class="tool-btn" data-tool="text" id="arch-tool-annotation" title="Add annotation">
              <i class="fas fa-font"></i>
            </button>
          </div>

          <div class="toolbar-group">
            <button type="button" class="tool-btn" id="arch-tool-copy" title="Copy (Ctrl+C)">
              <i class="fas fa-copy"></i>
            </button>
            <button type="button" class="tool-btn" id="arch-tool-paste" title="Paste (Ctrl+V)">
              <i class="fas fa-paste"></i>
            </button>
            <button type="button" class="tool-btn" id="arch-tool-delete" title="Delete (Delete)">
              <i class="fas fa-trash"></i>
            </button>
          </div>

          <div class="toolbar-group">
            <button type="button" class="tool-btn" id="arch-tool-group" title="Group (Ctrl+G)">
              <i class="fas fa-object-group"></i>
            </button>
            <button type="button" class="tool-btn" id="arch-tool-ungroup" title="Ungroup (Ctrl+Shift+G)">
              <i class="fas fa-object-ungroup"></i>
            </button>
            <button type="button" class="tool-btn" id="arch-align-left" title="Align left">
              <i class="fas fa-align-left"></i>
            </button>
            <button type="button" class="tool-btn" id="arch-align-center" title="Align center">
              <i class="fas fa-align-center"></i>
            </button>
          </div>

          <div class="toolbar-group">
            <button type="button" class="tool-btn" id="arch-undo" title="Undo (Ctrl+Z)">
              <i class="fas fa-undo-alt"></i>
            </button>
            <button type="button" class="tool-btn" id="arch-redo" title="Redo (Ctrl+Y)">
              <i class="fas fa-redo-alt"></i>
            </button>
          </div>
        </div>

        <div class="architecture-stage-wrapper" id="architecture-stage-wrapper">
          <div id="architecture-stage" class="architecture-stage"></div>
          <div id="architecture-minimap" class="architecture-minimap"></div>
          <div class="architecture-grid-overlay" id="architecture-grid-overlay"></div>
          <div class="architecture-empty-state" id="architecture-empty-state">
            <i class="fas fa-sitemap"></i>
            <p>Generate from Step 4 or drag devices here to build your architecture.</p>
          </div>
        </div>

        <div class="architecture-footer">
          <div class="footer-section">
            <label class="footer-label" for="arch-zoom-slider"><i class="fas fa-search"></i> Zoom</label>
            <div class="zoom-controls">
              <button type="button" class="zoom-btn" id="arch-zoom-out"><i class="fas fa-minus"></i></button>
              <input type="range" min="0.25" max="2.5" step="0.05" value="1" id="arch-zoom-slider"/>
              <button type="button" class="zoom-btn" id="arch-zoom-in"><i class="fas fa-plus"></i></button>
            </div>
          </div>
          <div class="footer-section toggles">
            <label class="toggle">
              <input type="checkbox" id="arch-toggle-grid" checked/>
              <span>Grid</span>
            </label>
            <label class="toggle">
              <input type="checkbox" id="arch-toggle-snap" checked/>
              <span>Snap to ports</span>
            </label>
          </div>
          <div class="footer-section exports">
            <button type="button" class="btn btn-tertiary" id="arch-export-png">
              <i class="fas fa-file-image"></i> PNG
            </button>
            <button type="button" class="btn btn-tertiary" id="arch-export-pdf">
              <i class="fas fa-file-pdf"></i> PDF
            </button>
          </div>
        </div>
      </div>

      <aside class="architecture-inspector" id="architecture-inspector">
        <div class="inspector-header">
          <span><i class="fas fa-info-circle"></i> Inspector</span>
          <button type="button" class="icon-btn" id="inspector-collapse">
            <i class="fas fa-chevron-right"></i>
          </button>
        </div>
        <div class="inspector-content">
          <section class="inspector-section" data-view="node">
            <h4>Device</h4>
            <label>
              <span>Label</span>
              <input type="text" id="inspector-node-label"/>
            </label>
            <label>
              <span>Model</span>
              <input type="text" id="inspector-node-model"/>
            </label>
            <label>
              <span>Notes</span>
              <textarea id="inspector-node-notes" rows="2"></textarea>
            </label>
            <div class="inspector-grid">
              <label>
                <span>IP Address</span>
                <input type="text" id="inspector-node-ip" placeholder="192.168.0.10"/>
              </label>
              <label>
                <span>Slot</span>
                <input type="text" id="inspector-node-slot" placeholder="Rack 0 / Slot 1"/>
              </label>
            </div>
            <label>
              <span>Tags</span>
              <input type="text" id="inspector-node-tags" placeholder="PLC, Field, VLAN10"/>
            </label>
            <button type="button" class="btn btn-secondary inspector-apply" id="inspector-node-apply">
              <i class="fas fa-check"></i> Apply Changes
            </button>
          </section>

          <section class="inspector-section" data-view="connection">
            <h4>Connection</h4>
            <label>
              <span>Label</span>
              <input type="text" id="inspector-connection-label" placeholder="Ethernet uplink"/>
            </label>
            <div class="inspector-grid">
              <label>
                <span>Type</span>
                <input type="text" id="inspector-connection-type" placeholder="Ethernet / Fiber / RS485"/>
              </label>
              <label>
                <span>Color</span>
                <input type="color" id="inspector-connection-color" value="#1f2937"/>
              </label>
            </div>
            <div class="inspector-grid">
              <label>
                <span>Width</span>
                <input type="number" id="inspector-connection-width" min="1" max="12" step="1" value="2"/>
              </label>
              <label>
                <span>Style</span>
                <select id="inspector-connection-style">
                  <option value="straight">Straight</option>
                  <option value="curved">Curved</option>
                  <option value="orthogonal">Orthogonal</option>
                </select>
              </label>
            </div>
            <div class="inspector-grid">
              <label>
                <span>Start Arrow</span>
                <select id="inspector-connection-arrow-start">
                  <option value="none">None</option>
                  <option value="circle">Circle</option>
                  <option value="triangle">Triangle</option>
                </select>
              </label>
              <label>
                <span>End Arrow</span>
                <select id="inspector-connection-arrow-end">
                  <option value="triangle">Triangle</option>
                  <option value="circle">Circle</option>
                  <option value="none">None</option>
                </select>
              </label>
            </div>
            <label>
              <span>Notes</span>
              <textarea id="inspector-connection-notes" rows="2"></textarea>
            </label>
            <button type="button" class="btn btn-secondary inspector-apply" id="inspector-connection-apply">
              <i class="fas fa-check"></i> Apply Changes
            </button>
          </section>

          <section class="inspector-section" data-view="canvas">
            <h4>Canvas</h4>
            <label>
              <span>Background</span>
              <input type="color" id="inspector-canvas-background" value="#f5f7fb"/>
            </label>
            <label>
              <span>Grid Size</span>
              <input type="number" id="inspector-canvas-grid-size" min="8" max="160" step="4" value="32"/>
            </label>
            <button type="button" class="btn btn-secondary inspector-apply" id="inspector-canvas-apply">
              <i class="fas fa-check"></i> Apply Canvas Settings
            </button>
          </section>
        </div>
      </aside>
    </div>

    <div class="architecture-bottom-bar">
      <div class="bottom-left">
        <button type="button" class="btn btn-secondary" id="arch-save-version">
          <i class="fas fa-book-medical"></i> Save Snapshot
        </button>
        <select id="arch-version-selector" class="version-selector">
          <option value="">Version history</option>
        </select>
      </div>
      <div class="bottom-center">
        <label class="toggle">
          <input type="checkbox" id="arch-live-sync"/>
          <span>Live co-editing</span>
        </label>
        <span class="collab-status" id="arch-collab-status">
          <i class="fas fa-user-slash"></i> Offline
        </span>
      </div>
      <div class="bottom-right architecture-actions">
        <button type="button" class="btn btn-secondary" id="btn-generate-architecture">
          <i class="fas fa-diagram-project"></i> Generate from Equipment List
        </button>
        <button type="button" class="btn btn-tertiary" id="btn-architecture-reset">
          <i class="fas fa-undo-alt"></i> Reset Layout
        </button>
        <button type="button" class="btn btn-primary" id="btn-architecture-save">
          <i class="fas fa-save"></i> Store Layout
        </button>
        <button type="button" class="btn btn-primary" id="btn-architecture-sync">
          <i class="fas fa-cloud-upload-alt"></i> Sync to Report
        </button>
      </div>
    </div>
  </div>

  <input type="hidden"
         name="system_architecture_layout"
         id="system_architecture_layout"
         value="{{ submission_data.SYSTEM_ARCHITECTURE_LAYOUT | default('') }}"/>

  <div class="btn-group">
    <button type="button" class="btn btn-secondary" onclick="goToStep(5)">
      <i class="fas fa-arrow-left"></i> Previous
    </button>
    <button type="button" class="btn btn-primary" onclick="goToStep(7)">
      <i class="fas fa-arrow-right"></i> Next Step
    </button>
  </div>
</fieldset>
