{% extends 'base.html' %}

{% block title %}SAT Report Status - {{ document_title }}{% endblock %}

{% block head %}
  {{ super() }}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard-light.css') }}">
  <style>
    .status-page .page-hero__content {
      display: flex;
      flex-direction: column;
      gap: var(--space-sm);
    }
    .status-page .status-chip-group {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-sm);
      margin-top: var(--space-md);
    }
    .status-page .page-hero .status-chip {
      background: rgba(255, 255, 255, 0.18);
      border: 1px solid rgba(255, 255, 255, 0.32);
      color: var(--cully-white);
      font-size: 0.9rem;
    }
    .status-page .page-hero .status-chip.status-chip--danger {
      background: rgba(239, 68, 68, 0.28);
      border-color: transparent;
    }
    .status-page .page-hero .status-chip.status-chip--success {
      background: rgba(34, 197, 94, 0.28);
      border-color: transparent;
    }
    .status-page .page-hero .status-chip.status-chip--pending {
      background: rgba(250, 204, 21, 0.3);
      border-color: transparent;
    }
    .status-page .status-chip--locked {
      background: rgba(44, 62, 80, 0.16);
      border: 1px solid rgba(44, 62, 80, 0.35);
      color: var(--cully-dark);
    }
    .status-page .summary-grid {
      margin-top: var(--space-md);
    }
    .status-page .summary-card__value {
      font-size: 1.35rem;
      word-break: break-word;
    }
    .status-page .status-grid {
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(0, 1.25fr);
      gap: var(--space-xl);
    }
    .status-page .status-meta {
      display: grid;
      gap: var(--space-sm);
      margin: 0;
    }
    .status-page .status-meta__row {
      display: grid;
      grid-template-columns: minmax(150px, 0.9fr) minmax(0, 1.6fr);
      gap: var(--space-md);
      padding: var(--space-sm) 0;
      border-bottom: 1px solid rgba(90, 127, 163, 0.12);
    }
    .status-page .status-meta__row:last-child {
      border-bottom: none;
    }
    .status-page .status-meta__label {
      font-weight: 600;
      color: var(--cully-gray);
    }
    .status-page .status-meta__value {
      color: var(--cully-dark);
      word-break: break-word;
    }
    .status-page .status-insight {
      display: flex;
      gap: var(--space-md);
      align-items: flex-start;
      padding: var(--space-md);
      border-radius: 14px;
      background: rgba(90, 127, 163, 0.1);
      color: var(--cully-dark);
      margin-bottom: var(--space-lg);
    }
    .status-page .status-insight i {
      font-size: 1.6rem;
      color: var(--cully-navy);
    }
    .status-page .status-next-actions {
      list-style: none;
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-sm);
      margin: 0;
      padding: 0;
    }
    .status-page .status-next-actions a {
      display: inline-flex;
      align-items: center;
      gap: var(--space-xs);
      padding: 0.6rem 1rem;
      border-radius: 12px;
      background: rgba(90, 127, 163, 0.12);
      color: var(--cully-navy);
      font-weight: 600;
      text-decoration: none;
      transition: background 0.2s ease;
    }
    .status-page .status-next-actions a:hover {
      background: rgba(90, 127, 163, 0.18);
    }
    .status-page .approval-timeline {
      list-style: none;
      margin: 0;
      padding: 0;
      display: grid;
      gap: var(--space-lg);
      position: relative;
    }
    .status-page .approval-timeline__item {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: var(--space-md);
      position: relative;
      padding-left: var(--space-xs);
    }
    .status-page .approval-timeline__item::before {
      content: '';
      position: absolute;
      left: 32px;
      top: 56px;
      bottom: -var(--space-lg);
      width: 2px;
      background: rgba(90, 127, 163, 0.18);
    }
    .status-page .approval-timeline__item:last-child::before {
      display: none;
    }
    .status-page .approval-timeline__indicator {
      width: 52px;
      height: 52px;
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.4rem;
      color: var(--cully-white);
      background: linear-gradient(135deg, var(--cully-blue), var(--cully-navy));
      box-shadow: var(--shadow-sm);
    }
    .status-page .approval-timeline__indicator--approved {
      background: linear-gradient(135deg, #22c55e, #15803d);
    }
    .status-page .approval-timeline__indicator--rejected {
      background: linear-gradient(135deg, #ef4444, #b91c1c);
    }
    .status-page .approval-timeline__indicator--pending,
    .status-page .approval-timeline__indicator--in_review {
      background: linear-gradient(135deg, #facc15, #f97316);
    }
    .status-page .approval-timeline__content {
      display: grid;
      gap: var(--space-xs);
    }
    .status-page .approval-stage-title {
      font-weight: 600;
      color: var(--cully-dark);
    }
    .status-page .approval-meta {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-sm);
      font-size: 0.9rem;
      color: var(--cully-gray);
    }
    .status-page .approval-status {
      display: inline-flex;
      align-items: center;
      gap: var(--space-xs);
      padding: 0.35rem 0.75rem;
      border-radius: 999px;
      font-size: 0.8rem;
      font-weight: 600;
    }
    .status-page .approval-status--approved {
      background: rgba(34, 197, 94, 0.16);
      color: #15803d;
    }
    .status-page .approval-status--pending,
    .status-page .approval-status--in_review {
      background: rgba(250, 204, 21, 0.18);
      color: #b45309;
    }
    .status-page .approval-status--rejected {
      background: rgba(239, 68, 68, 0.2);
      color: #b91c1c;
    }
    .status-page .approval-status--unknown {
      background: rgba(90, 127, 163, 0.16);
      color: var(--cully-dark);
    }
    .status-page .approval-comment {
      background: rgba(90, 127, 163, 0.08);
      border-radius: 12px;
      padding: var(--space-sm) var(--space-md);
      color: var(--cully-dark);
      font-size: 0.95rem;
    }
    @media (max-width: 1024px) {
      .status-page .status-grid {
        grid-template-columns: 1fr;
      }
    }
    @media (max-width: 768px) {
      .status-page .page-hero__actions {
        width: 100%;
      }
      .status-page .page-hero__actions .btn {
        width: 100%;
        justify-content: center;
      }
    }
  </style>
{% endblock %}

{% block content %}
{% set status_map = {
  'approved': {'label': 'Approved', 'class': 'status-chip--success', 'icon': 'fa-circle-check'},
  'rejected': {'label': 'Rejected', 'class': 'status-chip--danger', 'icon': 'fa-circle-xmark'},
  'partially_approved': {'label': 'Partially Approved', 'class': 'status-chip--warning', 'icon': 'fa-circle-half-stroke'},
  'pending': {'label': 'Awaiting Review', 'class': 'status-chip--pending', 'icon': 'fa-clock'}
} %}
{% set status_display = status_map.get(overall_status, status_map['pending']) %}
{% set project_reference = project_reference or submission_data.get('PROJECT_REFERENCE') %}
{% set client_name = client_name or submission_data.get('CLIENT_NAME') %}
{% set revision = submission_data.get('REVISION') %}
{% set revision_date = submission_data.get('REVISION_DATE') %}
{% set document_reference = submission_data.get('DOCUMENT_REFERENCE') %}
{% set report_date = submission_data.get('DATE') %}
{% set pending_approvals = approvals | selectattr('status', 'equalto', 'pending') | list %}
{% set next_pending = pending_approvals[0] if pending_approvals else None %}

<section class="cully-page status-page">
  <header class="page-hero">
    <div class="page-hero__content">
      <h1 class="page-hero__title">
        <i class="fas fa-clipboard-check"></i>
        {{ document_title or 'SAT Report' }}
      </h1>
      <p class="page-hero__subtitle">
        Track approvals, revisions, and downloads for this submission in one streamlined view.
      </p>
      <div class="status-chip-group">
        <span class="status-chip {{ status_display.class }}">
          <i class="fas {{ status_display.icon }}"></i> {{ status_display.label }}
        </span>
        {% if locked %}
        <span class="status-chip status-chip--locked">
          <i class="fas fa-lock"></i> Locked
        </span>
        {% endif %}
        {% if can_edit and not locked %}
        <span class="status-chip status-chip--success">
          <i class="fas fa-pen-to-square"></i> Editable
        </span>
        {% endif %}
      </div>
    </div>
    <div class="page-hero__actions">
      {% if can_edit and not locked %}
      <a href="{{ url_for('edit.edit_report', report_id=submission_id) }}" class="btn btn--ghost">
        <i class="fas fa-pen"></i> Continue Editing
      </a>
      {% endif %}
      <a href="{{ url_for('status.download_report', submission_id=submission_id) }}" class="btn btn--primary">
        <i class="fas {% if has_pdf %}fa-file-pdf{% else %}fa-file-download{% endif %}"></i>
        {% if download_available %}Download Latest{% else %}Generate Report{% endif %}
      </a>
    </div>
  </header>

  <div class="summary-grid">
    <article class="summary-card">
      <div class="summary-card__icon" aria-hidden="true">
        <i class="fas fa-diagram-project"></i>
      </div>
      <div>
        <p class="summary-card__value">{{ project_reference or '—' }}</p>
        <p class="summary-card__label">Project Reference</p>
      </div>
    </article>
    <article class="summary-card">
      <div class="summary-card__icon" aria-hidden="true" style="background: linear-gradient(135deg, #60a5fa, #3b82f6);">
        <i class="fas fa-building"></i>
      </div>
      <div>
        <p class="summary-card__value">{{ client_name or '—' }}</p>
        <p class="summary-card__label">Client</p>
      </div>
    </article>
    <article class="summary-card">
      <div class="summary-card__icon" aria-hidden="true" style="background: linear-gradient(135deg, #facc15, #f59e0b);">
        <i class="fas fa-code-branch"></i>
      </div>
      <div>
        <p class="summary-card__value">{{ revision or 'Not set' }}</p>
        <p class="summary-card__label">Revision</p>
      </div>
    </article>
    <article class="summary-card">
      <div class="summary-card__icon" aria-hidden="true" style="background: linear-gradient(135deg, #22c55e, #16a34a);">
        <i class="fas fa-clock-rotate-left"></i>
      </div>
      <div>
        <p class="summary-card__value">{{ updated_at or 'Not recorded' }}</p>
        <p class="summary-card__label">Last Updated</p>
      </div>
    </article>
  </div>

  <div class="status-grid">
    <article class="card-shell">
      <div class="card-shell__header">
        <h2 class="card-shell__title">
          <i class="fas fa-circle-info"></i> Submission Overview
        </h2>
      </div>
      <div class="card-shell__body">
        <dl class="status-meta">
          <div class="status-meta__row">
            <dt class="status-meta__label">Document Reference</dt>
            <dd class="status-meta__value">{{ document_reference or '—' }}</dd>
          </div>
          <div class="status-meta__row">
            <dt class="status-meta__label">Report Owner</dt>
            <dd class="status-meta__value">{{ user_email or '—' }}</dd>
          </div>
          <div class="status-meta__row">
            <dt class="status-meta__label">Prepared By</dt>
            <dd class="status-meta__value">{{ prepared_by or '—' }}</dd>
          </div>
          <div class="status-meta__row">
            <dt class="status-meta__label">Submission Date</dt>
            <dd class="status-meta__value">{{ report_date or '—' }}</dd>
          </div>
          <div class="status-meta__row">
            <dt class="status-meta__label">Revision Date</dt>
            <dd class="status-meta__value">{{ revision_date or '—' }}</dd>
          </div>
          <div class="status-meta__row">
            <dt class="status-meta__label">Created</dt>
            <dd class="status-meta__value">{{ created_at or '—' }}</dd>
          </div>
          <div class="status-meta__row">
            <dt class="status-meta__label">Last Updated</dt>
            <dd class="status-meta__value">{{ updated_at or '—' }}</dd>
          </div>
          <div class="status-meta__row">
            <dt class="status-meta__label">Download Status</dt>
            <dd class="status-meta__value">
              {% if download_available %}
                Ready · {{ 'PDF available' if has_pdf else 'DOCX available' }}
              {% else %}
                Report file has not been generated yet
              {% endif %}
            </dd>
          </div>
        </dl>
      </div>
    </article>

    <article class="card-shell">
      <div class="card-shell__header">
        <h2 class="card-shell__title">
          <i class="fas fa-flowchart"></i> Approval Flow
        </h2>
      </div>
      <div class="card-shell__body">
        {% if approvals %}
        <ol class="approval-timeline">
          {% set status_labels = {
            'approved': {'label': 'Approved', 'icon': 'fa-circle-check', 'badge': 'approval-status--approved', 'indicator': 'approval-timeline__indicator--approved'},
            'pending': {'label': 'Awaiting Review', 'icon': 'fa-clock', 'badge': 'approval-status--pending', 'indicator': 'approval-timeline__indicator--pending'},
            'rejected': {'label': 'Rejected', 'icon': 'fa-circle-xmark', 'badge': 'approval-status--rejected', 'indicator': 'approval-timeline__indicator--rejected'},
            'in_review': {'label': 'In Review', 'icon': 'fa-hourglass-half', 'badge': 'approval-status--in_review', 'indicator': 'approval-timeline__indicator--in_review'},
            'default': {'label': 'Pending Update', 'icon': 'fa-ellipsis', 'badge': 'approval-status--unknown', 'indicator': ''}
          } %}
          {% for approval in approvals %}
            {% set status_lower = (approval.status or 'pending')|lower %}
            {% set status_info = status_labels.get(status_lower, status_labels['default']) %}
            {% set indicator_class = status_info.indicator %}
            <li class="approval-timeline__item">
              <div class="approval-timeline__indicator {{ indicator_class }}">
                <i class="fas {{ status_info.icon }}"></i>
              </div>
              <div class="approval-timeline__content">
                <div class="approval-stage-title">
                  Stage {{ approval.stage or loop.index }} · {{ approval.title or 'Approver' }}
                </div>
                <div class="approval-meta">
                  <span><i class="fas fa-user-circle"></i> {{ approval.approver_email or '—' }}</span>
                  <span class="approval-status {{ status_info.badge }}">
                    <i class="fas {{ status_info.icon }}"></i> {{ status_info.label }}
                  </span>
                  {% if approval.timestamp %}
                  <span><i class="fas fa-clock"></i> {{ approval.timestamp }}</span>
                  {% endif %}
                  {% if approval.signature %}
                  <span><i class="fas fa-signature"></i> Signature captured</span>
                  {% endif %}
                </div>
                {% if approval.comment %}
                <div class="approval-comment">
                  <i class="fas fa-comment-dots"></i> {{ approval.comment }}
                </div>
                {% endif %}
              </div>
            </li>
          {% endfor %}
        </ol>
        {% else %}
        <div class="empty-state">
          <i class="fas fa-circle-exclamation" aria-hidden="true"></i>
          <h4>No approval workflow attached</h4>
          <p>Assign approvers from the dashboard to begin routing this submission through review.</p>
        </div>
        {% endif %}
      </div>
    </article>
  </div>

  <article class="card-shell">
    <div class="card-shell__header">
      <h2 class="card-shell__title">
        <i class="fas fa-compass"></i> Next Steps & Resources
      </h2>
    </div>
    <div class="card-shell__body">
      <div class="status-insight">
        {% if overall_status == 'approved' %}
        <i class="fas fa-circle-check"></i>
        <div>
          <strong>All approvals are complete.</strong> Share the final package with your client or archive the submission.
        </div>
        {% elif overall_status == 'rejected' %}
        <i class="fas fa-circle-xmark"></i>
        <div>
          <strong>The submission was rejected.</strong> Review the approver comments above and submit updates via the SAT wizard.
        </div>
        {% elif overall_status == 'partially_approved' %}
        <i class="fas fa-adjust"></i>
        <div>
          <strong>Some approvals are in.</strong>
          {% if next_pending %}
            Waiting on {{ next_pending.title or 'the next approver' }} ({{ next_pending.approver_email or '—' }}) to finalise the review.
          {% else %}
            Remaining approvers have not been assigned yet.
          {% endif %}
        </div>
        {% else %}
        <i class="fas fa-hourglass-half"></i>
        <div>
          <strong>Approval workflow in progress.</strong>
          {% if next_pending %}
            Next action: {{ next_pending.title or 'Approver' }} ({{ next_pending.approver_email or '—' }}) needs to review the submission.
          {% else %}
            Invite approvers or nudge your team to keep things moving.
          {% endif %}
        </div>
        {% endif %}
      </div>
      <ul class="status-next-actions">
        <li>
          <a href="{{ url_for('status.download_report', submission_id=submission_id) }}">
            <i class="fas fa-download"></i> {{ 'Download PDF' if has_pdf else 'Download Package' }}
          </a>
        </li>
        {% if can_edit and not locked %}
        <li>
          <a href="{{ url_for('edit.edit_report', report_id=submission_id) }}">
            <i class="fas fa-pen-to-square"></i> Open in SAT Wizard
          </a>
        </li>
        {% endif %}
        <li>
          <a href="{{ url_for('reports.new_sat_full', template_id=submission_id) }}">
            <i class="fas fa-copy"></i> Duplicate Submission
          </a>
        </li>
        <li>
          <a href="{{ url_for('dashboard.my_reports') }}">
            <i class="fas fa-table-list"></i> Back to My Reports
          </a>
        </li>
      </ul>
    </div>
  </article>
</section>
{% endblock %}

{% block scripts %}
  {{ super() }}
  {% if auto_download and download_available %}
  <script>
    window.addEventListener('load', function () {
      var downloadUrl = {{ url_for('status.download_report', submission_id=submission_id) | tojson }};
      var storageKey = 'status-auto-download-' + {{ submission_id | tojson }};
      if (!sessionStorage.getItem(storageKey)) {
        sessionStorage.setItem(storageKey, '1');
        window.open(downloadUrl, '_blank');
      }
    });
  </script>
  {% endif %}
{% endblock %}
