{% extends "base.html" %}

{% block title %}Project Manager Dashboard - {{ super() }}{% endblock %}

{% block head %}
<style>
  .dashboard-summary {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: var(--space-lg);
    margin-bottom: var(--space-xl);
  }

  .summary-card {
    background: var(--cully-white);
    border-radius: 20px;
    box-shadow: var(--shadow-sm);
    border: 1px solid rgba(90, 127, 163, 0.08);
    padding: var(--space-lg);
    display: flex;
    align-items: center;
    gap: var(--space-md);
    transition: var(--transition-smooth);
  }

  .summary-card:hover {
    transform: translateY(-3px);
    box-shadow: var(--shadow-lg);
  }

  .summary-icon {
    width: 64px;
    height: 64px;
    border-radius: 18px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
    color: var(--cully-white);
  }

  .summary-icon--draft { background: linear-gradient(145deg, #60a5fa, #3b82f6); }
  .summary-icon--pending { background: linear-gradient(145deg, #facc15, #f59e0b); }
  .summary-icon--rejected { background: linear-gradient(145deg, #fca5a5, #ef4444); }
  .summary-icon--approved { background: linear-gradient(145deg, #86efac, #22c55e); }
  .summary-icon--received { background: linear-gradient(145deg, #c084fc, #a855f7); }
  .summary-icon--processed { background: linear-gradient(145deg, #5eead4, #14b8a6); }
  .summary-icon--total { background: linear-gradient(145deg, #94a3b8, #475569); }

  .summary-meta {
    display: flex;
    flex-direction: column;
    gap: var(--space-xs);
  }

  .summary-value {
    font-size: 2.2rem;
    font-weight: 700;
    color: var(--cully-dark);
    line-height: 1;
  }

  .summary-label {
    color: var(--cully-gray);
    font-weight: 600;
  }

.action-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    gap: var(--space-lg);
    margin-bottom: var(--space-xl);
  }

  .action-card {
    background: var(--cully-white);
    border-radius: 20px;
    box-shadow: var(--shadow-sm);
    border: 1px solid rgba(90, 127, 163, 0.08);
    padding: var(--space-lg);
    text-decoration: none;
    color: var(--cully-dark);
    display: flex;
    flex-direction: column;
    gap: var(--space-md);
    transition: var(--transition-smooth);
  }

  .action-card:hover {
    transform: translateY(-3px);
    box-shadow: var(--shadow-lg);
    color: var(--cully-navy);
  }

  .action-header {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
  }

  .action-icon {
    font-size: 1.4rem;
    color: var(--cully-blue);
  }

  .action-title {
    margin: 0;
    font-size: 1.15rem;
    font-weight: 600;
  }

  .action-description {
    margin: 0;
    color: var(--cully-gray);
    line-height: 1.5;
  }

  .action-link {
    margin-left: auto;
    font-weight: 600;
    color: var(--cully-blue);
  }

  .action-link i { margin-left: 0.35rem; }

  .widget-card {
    background: var(--cully-white);
    border-radius: 20px;
    box-shadow: var(--shadow-sm);
    border: 1px solid rgba(90, 127, 163, 0.08);
    overflow: hidden;
  }

  .widget-header {
    padding: var(--space-lg);
    border-bottom: 1px solid rgba(90, 127, 163, 0.08);
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: var(--space-md);
  }

  .widget-title {
    margin: 0;
    font-size: 1.2rem;
    font-weight: 600;
    color: var(--cully-dark);
    display: inline-flex;
    align-items: center;
    gap: var(--space-sm);
  }

  .widget-action {
    text-decoration: none;
    font-weight: 600;
    color: var(--cully-blue);
    font-size: 0.95rem;
  }

  .pending-list {
    padding: var(--space-lg);
    display: grid;
    gap: var(--space-md);
  }

  .pending-list-item {
    border-radius: 16px;
    padding: var(--space-md);
    border: 1px solid rgba(90, 127, 163, 0.12);
    display: grid;
    gap: var(--space-sm);
    background: rgba(90, 127, 163, 0.04);
  }

  .pending-info {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-sm);
    justify-content: space-between;
    align-items: center;
  }

  .pending-title {
    font-weight: 600;
    color: var(--cully-dark);
  }

  .pending-meta {
    color: var(--cully-gray);
  }

  .pending-actions {
    display: flex;
    gap: var(--space-xs);
  }

  .pending-actions a {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    border-radius: 10px;
    border: 1px solid rgba(90, 127, 163, 0.28);
    color: var(--cully-dark);
    text-decoration: none;
  }

  .pending-actions a:hover {
    background: rgba(90, 127, 163, 0.18);
  }

.reviews-empty {
  padding: var(--space-xl);
  text-align: center;
  color: var(--cully-gray);
}

  .reviews-empty i {
    font-size: 2.4rem;
    margin-bottom: var(--space-sm);
  }
</style>
{% endblock %}

{% block content %}
<section class="page-hero">
  <div class="page-hero__content">
    <div>
      <h1 class="page-hero__title">Project Manager Dashboard</h1>
      <p class="page-hero__subtitle">
        Welcome back, {{ current_user.full_name if current_user and current_user.full_name else 'Project Manager' }}.
        Oversee deliverables, keep approvals moving, and stay aligned with the team.
      </p>
    </div>
  </div>
</section>

<nav class="module-nav">
  <div class="module-nav__links">
    <a class="module-nav__link module-nav__link--active" href="{{ url_for('dashboard.pm') }}"><i class="fas fa-home"></i> Dashboard</a>
    <a class="module-nav__link" href="{{ url_for('dashboard.my_reports') }}"><i class="fas fa-folder-open"></i> Reports</a>
    <a class="module-nav__link" href="{{ url_for('dashboard.pm') }}#pending-approvals"><i class="fas fa-list-check"></i> Reviews</a>
    <a class="module-nav__link" href="{{ url_for('notifications.notification_center') }}"><i class="fas fa-bell"></i> Notifications</a>
  </div>
  <div class="module-nav__meta">
    <i class="fas fa-chart-line"></i> Your approval queue at a glance
  </div>
</nav>

{% set stats = stats if stats is defined else {} %}

<div class="dashboard-summary">
  <article class="summary-card">
    <span class="summary-icon summary-icon--draft"><i class="fas fa-file-alt"></i></span>
    <div class="summary-meta">
      <div class="summary-value">{{ stats.get('draft', 0) }}</div>
      <div class="summary-label">Reports in draft</div>
    </div>
  </article>
  <article class="summary-card">
    <span class="summary-icon summary-icon--pending"><i class="fas fa-paper-plane"></i></span>
    <div class="summary-meta">
      <div class="summary-value">{{ stats.get('pending', 0) }}</div>
      <div class="summary-label">Pending approval</div>
    </div>
  </article>
  <article class="summary-card">
    <span class="summary-icon summary-icon--rejected"><i class="fas fa-exclamation-circle"></i></span>
    <div class="summary-meta">
      <div class="summary-value">{{ stats.get('rejected', 0) }}</div>
      <div class="summary-label">Rejected reports</div>
    </div>
  </article>
  <article class="summary-card">
    <span class="summary-icon summary-icon--approved"><i class="fas fa-check-circle"></i></span>
    <div class="summary-meta">
      <div class="summary-value">{{ stats.get('approved', 0) }}</div>
      <div class="summary-label">Approved reports</div>
    </div>
  </article>
  <article class="summary-card">
    <span class="summary-icon summary-icon--received"><i class="fas fa-inbox"></i></span>
    <div class="summary-meta">
      <div class="summary-value">{{ stats.get('requests_received', 0) }}</div>
      <div class="summary-label">Requests received</div>
    </div>
  </article>
  <article class="summary-card">
    <span class="summary-icon summary-icon--processed"><i class="fas fa-handshake"></i></span>
    <div class="summary-meta">
      <div class="summary-value">{{ stats.get('requests_approved', 0) }}</div>
      <div class="summary-label">Requests approved</div>
    </div>
  </article>
  <article class="summary-card">
    <span class="summary-icon summary-icon--total"><i class="fas fa-layer-group"></i></span>
    <div class="summary-meta">
      <div class="summary-value">{{ stats.get('total_reports', 0) }}</div>
      <div class="summary-label">Total reports</div>
    </div>
  </article>
</div>

<div class="widget-card" id="pending-approvals">
  <div class="widget-header">
    <h3 class="widget-title"><i class="fas fa-exclamation-triangle"></i> Approvals awaiting you</h3>
    <span class="widget-action">{{ pending_deliverables or 0 }} open items</span>
  </div>
  <div class="pending-list">
    {% if pending_reports and pending_reports|length > 0 %}
      {% for report in pending_reports %}
        <div class="pending-list-item">
          <div class="pending-info">
            <div class="pending-title">{{ report.document_title or 'Untitled Report' }}</div>
            <div class="pending-meta">{{ report.client_name or 'Unknown Client' }} Â· {{ report.project_reference or 'N/A' }}</div>
          </div>
          <div class="pending-actions">
            <a href="{{ url_for('status.view_status', submission_id=report.id) }}" title="View status"><i class="fas fa-eye"></i></a>
            {% if report.approval_url %}
              <a href="{{ report.approval_url }}" title="Approve"><i class="fas fa-check"></i></a>
              <a href="{{ report.approval_url }}#reject" title="Reject"><i class="fas fa-times"></i></a>
            {% endif %}
          </div>
        </div>
      {% endfor %}
    {% else %}
      <div class="reviews-empty">
        <i class="fas fa-check-circle"></i>
        <h3>No approvals waiting</h3>
        <p>Enjoy the clear runway! You'll see new items here as engineers submit their work.</p>
      </div>
    {% endif %}
  </div>
</div>

<div class="action-grid">
  <a href="{{ url_for('dashboard.pm') }}#pending-approvals" class="action-card">
    <div class="action-header">
      <i class="fas fa-list-check action-icon"></i>
      <h3 class="action-title">Pending approvals</h3>
    </div>
    <p class="action-description">Jump straight to the reports awaiting your stage-two approval.</p>
    <span class="action-link">View queue <i class="fas fa-arrow-right"></i></span>
  </a>
  <a href="{{ url_for('reports.new') }}" class="action-card">
    <div class="action-header">
      <i class="fas fa-plus-circle action-icon"></i>
      <h3 class="action-title">Create new report</h3>
    </div>
    <p class="action-description">Start a new SAT, Site Survey, or other report straight from approved templates.</p>
    <span class="action-link">Start now <i class="fas fa-arrow-right"></i></span>
  </a>
  <a href="{{ url_for('dashboard.my_reports') }}" class="action-card">
    <div class="action-header">
      <i class="fas fa-folder-open action-icon"></i>
      <h3 class="action-title">Team reports</h3>
    </div>
    <p class="action-description">Review the reports your engineers prepared so you can coordinate sign-off.</p>
    <span class="action-link">Browse reports <i class="fas fa-arrow-right"></i></span>
  </a>
  <a href="{{ url_for('notifications.notification_center') }}" class="action-card">
    <div class="action-header">
      <i class="fas fa-bell action-icon"></i>
      <h3 class="action-title">Notifications</h3>
    </div>
    <p class="action-description">Catch up on alerts, edits, and approvals that need your attention.</p>
    <span class="action-link">Open center <i class="fas fa-arrow-right"></i></span>
  </a>
</div>

<div class="widget-card">
  <div class="widget-header">
    <h3 class="widget-title"><i class="fas fa-clock"></i> Recent activity</h3>
    <a href="{{ url_for('dashboard.my_reports') }}" class="widget-action">View all reports</a>
  </div>
  <div class="pending-list">
    {% if recent_reports and recent_reports|length > 0 %}
      {% for report in recent_reports %}
        <div class="pending-list-item">
          <div class="pending-info">
            <div class="pending-title">{{ report.document_title or 'Untitled Report' }}</div>
            <div class="pending-meta">Updated {{ report.updated_at.strftime('%d %b %Y, %H:%M') if report.updated_at else 'Recently' }}</div>
          </div>
          <div class="pending-actions">
            <a href="{{ url_for('status.view_status', submission_id=report.id) }}" title="View"><i class="fas fa-eye"></i></a>
            <a href="{{ url_for('reports.new_sat_full', template_id=report.id) }}" title="Use as template"><i class="fas fa-copy"></i></a>
          </div>
        </div>
      {% endfor %}
    {% else %}
      <div class="reviews-empty">
        <i class="fas fa-file-circle-question"></i>
        <h3>No recent activity recorded</h3>
        <p>Once reports start moving through approvals, you'll see updates appear here.</p>
      </div>
    {% endif %}
  </div>
</div>
{% endblock %}
